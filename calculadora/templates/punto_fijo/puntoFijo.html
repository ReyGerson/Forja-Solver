{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Método de Punto Fijo</title>

    <link rel="stylesheet" href='{% static "css/puntoFijo.css" %}'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mathlive/dist/mathlive.min.css" />
</head>

<body>
    <h1>Método de Punto Fijo</h1>

    <div class="form-container">
        <h2 class="form-title">Ingrese los datos para el cálculo</h2>

        <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                <p class="text-danger">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-group">
                <label for="math_fx">Función F(x):</label>
                <math-field id="math_fx"></math-field>
                <input type="hidden" id="id_fx" name="funcion" value="{{ fx|default:'' }}">
                <input type="hidden" id="id_fx_latex" name="funcion_latex" value="{{ fx_latex|default:'' }}">
            </div>

            <div class="form-group">
                <label for="math_gx">Despeje g(x):</label>
                <math-field id="math_gx"></math-field>
                <input type="hidden" id="id_gx" name="despeje" value="{{ gx|default:'' }}">
                <input type="hidden" id="id_gx_latex" name="despeje_latex" value="{{ gx_latex|default:'' }}">
            </div>

            <div class="form-group">
                <label for="id_valor_inicial">Valor inicial:</label>
                <input type="number" id="id_valor_inicial" name="valor_inicial" step="any"
                    value="{{ form.data.valor_inicial|default:1 }}" required>
            </div>

            <div class="form-group">
                <label for="id_tolerancia">Tolerancia (%):</label>
                <input type="number" id="id_tolerancia" name="tolerancia" step="any" min="0"
                    value="{{ form.data.tolerancia|default:0.001 }}" required>
            </div>

            <div class="form-group">
                <label for="id_decimales">Número de decimales:</label>
                <input type="number" id="id_decimales" name="decimales" min="1" max="15"
                    value="{{ form.data.decimales|default:6 }}" required>
            </div>

            <button type="submit" class="submit-btn">Calcular</button>
        </form>
    </div>

    {% if resultado %}
    <div class="resultado">
        <h2>Resultado</h2>
        <p>Solución aproximada: <strong>{{ solucion }}</strong></p>
        <p>Error: <strong>{{ error }}%</strong></p>
        <p>Comprobación: F(x) = <strong>{{ comprobacion }}</strong></p>

        <h3>Iteraciones paso a paso:</h3>
        <ul>
            <li><strong>Valor inicial:</strong> <span class="alert">{{ form.cleaned_data.valor_inicial }}</span></li>
            {% for r in resultado %}
            <li>Iteración {{ r.iteracion }}: {{ r.detalle }}<br>{{ r.error_detalle }}</li>
            {% endfor %}
        </ul>

        <h3>Iteraciones</h3>
        <table>
            <thead>
                <tr>
                    <th>Iteración</th>
                    <th>Xi</th>
                    <th>Error %</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>v.i</td>
                    <td class="alert">{{ form.data.valor_inicial }}</td>
                    <td>-</td>
                </tr>
                {% for r in resultado %}
                <tr>
                    <td>{{ r.iteracion }}</td>
                    <td>{{ r.x }}</td>
                    <td>{{ r.error }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <p><a href="{% url 'historialPuntoFijo' %}">Ver historial de ejecuciones anteriores</a></p>

    <script src="https://cdn.jsdelivr.net/npm/mathlive/dist/mathlive.min.js"></script>
    <script>
        function latexToNumExpr(latex) {
            return latex
                .replace(/\\left\(/g, "(")
                .replace(/\\right\)/g, ")")
                .replace(/\\cdot/g, "*")
                .replace(/\\frac\{([^}]*)\}\{([^}]*)\}/g, "($1)/($2)")
                .replace(/\\sqrt\{([^}]*)\}/g, "sqrt($1)")
                .replace(/exponentialE\*\*\{([^}]*)\}/g, "exp($1)")
                .replace(/exponentialE\^\{([^}]*)\}/g, "exp($1)")
                .replace(/exponentialE\^\(([^)]*)\)/g, "exp($1)")
                .replace(/exponentialE\^([^\s]+)/g, (match, p1) => `exp(${p1})`)
                .replace(/\\exp/g, "exp")
                .replace(/\\log/g, "log")
                .replace(/\\sin/g, "sin")
                .replace(/\\cos/g, "cos")
                .replace(/\\tan/g, "tan")
                .replace(/\\pi/g, "pi")
                .replace(/\\\^/g, "^")
                .replace(/\^/g, "**");
        }

        const mathFx = document.getElementById("math_fx");
        const inputFx = document.getElementById("id_fx");
        const inputFxLatex = document.getElementById("id_fx_latex");

        const mathGx = document.getElementById("math_gx");
        const inputGx = document.getElementById("id_gx");
        const inputGxLatex = document.getElementById("id_gx_latex");

        // Cargar valores iniciales
        window.addEventListener('load', () => {
            if (inputFxLatex.value) {
                mathFx.value = inputFxLatex.value;
            }
            if (inputGxLatex.value) {
                mathGx.value = inputGxLatex.value;
            }
        });

        // Escucha cambios en los campos
        mathFx.addEventListener("input", () => {
            inputFxLatex.value = mathFx.value;
            inputFx.value = latexToNumExpr(mathFx.value);
        });

        mathGx.addEventListener("input", () => {
            inputGxLatex.value = mathGx.value;
            inputGx.value = latexToNumExpr(mathGx.value);
        });

        // Antes de enviar el formulario, fuerza la actualización
        const form = document.querySelector("form");
        form.addEventListener("submit", (e) => {
            inputFxLatex.value = mathFx.value;
            inputFx.value = latexToNumExpr(mathFx.value);

            inputGxLatex.value = mathGx.value;
            inputGx.value = latexToNumExpr(mathGx.value);
        });
    </script>


</body>

</html>